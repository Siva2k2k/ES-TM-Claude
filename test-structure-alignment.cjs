const axios = require("axios");

async function testStructureAlignment() {
  try {
    console.log("ðŸ” Testing Preview vs Download Data Structure Alignment\n");

    // Login
    const loginResponse = await axios.post(
      "http://localhost:3001/api/v1/auth/login",
      {
        email: "employee1@company.com",
        password: "employee123",
      }
    );

    const token = loginResponse.data.tokens.accessToken;
    console.log("âœ… Authenticated successfully\n");

    const config = {
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
    };

    const payload = {
      template_id: "employee-timesheet-summary",
      date_range: {
        start: "2024-10-01",
        end: "2024-10-31",
      },
      filters: {},
    };

    // Test Preview Endpoint
    console.log("ðŸ“‹ Testing Preview Endpoint Structure:");
    const previewResponse = await axios.post(
      "http://localhost:3001/api/v1/reports/preview",
      payload,
      config
    );

    console.log("  Status:", previewResponse.status);
    console.log("  Main Keys:", Object.keys(previewResponse.data));

    if (previewResponse.data.success && previewResponse.data.report) {
      const report = previewResponse.data.report;
      console.log("  Report Keys:", Object.keys(report));
      console.log("  Data Records:", report.data?.length || 0);
      console.log("  Template Name:", report.template?.name);
      console.log("  Generated By:", report.metadata?.generated_by);

      if (report.data && report.data.length > 0) {
        console.log("  Sample Record Keys:", Object.keys(report.data[0]));
        console.log(
          "  Sample Record:",
          JSON.stringify(report.data[0], null, 2)
        );
      }
    }

    // Compare with what the generators expect
    console.log("\nðŸ“Š Generator Input Structure Analysis:");
    console.log(
      "  Expected by generators: { data: Array, metadata: Object, template: Object }"
    );
    console.log(
      "  Preview provides: { success: boolean, report: { data: Array, metadata: Object, template: Object } }"
    );
    console.log(
      '  ðŸŽ¯ MISMATCH IDENTIFIED: Preview wraps data in "report" object, generators expect flat structure'
    );

    // Test a hypothetical generator-compatible preview
    console.log("\nðŸ”§ Structure Alignment Recommendation:");
    console.log(
      "  Option 1: Update Preview to return flat structure like generators expect"
    );
    console.log("  Option 2: Update generators to handle preview structure");
    console.log("  Option 3: Create alignment layer in frontend");

    return {
      previewStructure: previewResponse.data,
      dataRecords: previewResponse.data.report?.data?.length || 0,
      mismatchDetected: true,
    };
  } catch (error) {
    console.error(
      "âŒ Structure test failed:",
      error.response?.data?.message || error.message
    );
    return null;
  }
}

testStructureAlignment().then((result) => {
  if (result) {
    console.log("\nðŸ“ˆ CONCLUSION:");
    console.log(`Data Records Found: ${result.dataRecords}`);
    console.log(
      `Structure Mismatch: ${result.mismatchDetected ? "YES" : "NO"}`
    );

    if (result.mismatchDetected) {
      console.log("\nâœ… Issue #1 ROOT CAUSE IDENTIFIED:");
      console.log(
        "Preview returns: { success, report: { data, metadata, template } }"
      );
      console.log("Generators expect: { data, metadata, template }");
      console.log(
        'Frontend needs to extract "report" object from preview response'
      );
    }
  }
});
