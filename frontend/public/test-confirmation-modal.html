<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VoiceConfirmationModal Dropdown Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .test-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .test-button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      .test-button:hover {
        background-color: #0056b3;
      }
      .test-button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .data-display {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        max-height: 300px;
        overflow-y: auto;
      }
      .field-analysis {
        border-left: 4px solid #007bff;
        padding-left: 15px;
        margin: 10px 0;
      }
      .dropdown-expected {
        background-color: #e3f2fd;
        padding: 8px;
        border-radius: 4px;
        margin: 5px 0;
      }
      .result-summary {
        border: 2px solid #28a745;
        background-color: #f8fff9;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>üß™ VoiceConfirmationModal Dropdown Test</h1>
    <p>
      This page tests the complete flow from backend APIs to frontend modal
      dropdown population.
    </p>

    <div class="test-container">
      <h2>üîê Authentication Test</h2>
      <button class="test-button" onclick="testAuthentication()">
        Test Authentication
      </button>
      <div id="auth-result"></div>
    </div>

    <div class="test-container">
      <h2>üìä Backend Data Sources Test</h2>
      <button class="test-button" onclick="testBackendAPIs()">
        Test Backend APIs
      </button>
      <div id="backend-result"></div>
    </div>

    <div class="test-container">
      <h2>üé§ Voice Command Processing Test</h2>
      <p>
        <strong>Sample Command:</strong> "Create a project named Internal
        Project 3.0 with Manager, Project Manager with budget $12,000 and client
        root stock. For the period. 12/12/2025 to 30/01/2026."
      </p>
      <button class="test-button" onclick="testVoiceProcessing()">
        Test Voice Processing
      </button>
      <div id="voice-result"></div>
    </div>

    <div class="test-container">
      <h2>üìã Expected Modal Behavior Analysis</h2>
      <button class="test-button" onclick="analyzeModalRequirements()">
        Analyze Modal Requirements
      </button>
      <div id="modal-analysis"></div>
    </div>

    <div class="test-container">
      <h2>üîó Frontend Integration Test</h2>
      <p>
        <strong>Note:</strong> This test simulates triggering the
        VoiceConfirmationModal. In a real scenario, you would use the microphone
        or voice interface.
      </p>
      <button class="test-button" onclick="simulateModalTrigger()">
        Simulate Modal Trigger
      </button>
      <div id="frontend-result"></div>
    </div>

    <script>
      let authToken = null;
      let backendData = {};
      let voiceProcessingResult = null;

      const BACKEND_URL = "http://localhost:3001";
      const SAMPLE_COMMAND =
        "Create a project named Internal Project 3.0 with Manager, Project Manager with budget $12,000 and client root stock. For the period. 12/12/2025 to 30/01/2026.";

      async function testAuthentication() {
        const resultDiv = document.getElementById("auth-result");
        resultDiv.innerHTML =
          '<div class="info">Testing authentication...</div>';

        try {
          const response = await fetch(`${BACKEND_URL}/api/v1/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: "admin@company.com",
              password: "admin123",
            }),
          });

          const data = await response.json();

          if (data.success) {
            authToken = data.tokens.accessToken;
            resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Authentication successful<br>
                            User: ${data.user.full_name} (${data.user.role})<br>
                            Token obtained and ready for API calls
                        </div>
                    `;
          } else {
            resultDiv.innerHTML = `<div class="error">‚ùå Authentication failed: ${data.message}</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå Authentication error: ${error.message}</div>`;
        }
      }

      async function testBackendAPIs() {
        if (!authToken) {
          document.getElementById("backend-result").innerHTML =
            '<div class="warning">‚ö†Ô∏è Please authenticate first</div>';
          return;
        }

        const resultDiv = document.getElementById("backend-result");
        resultDiv.innerHTML = '<div class="info">Testing backend APIs...</div>';

        try {
          // Test clients API
          const clientsResponse = await fetch(`${BACKEND_URL}/api/v1/clients`, {
            headers: { Authorization: `Bearer ${authToken}` },
          });
          const clientsData = await clientsResponse.json();

          // Test users API
          const usersResponse = await fetch(`${BACKEND_URL}/api/v1/users`, {
            headers: { Authorization: `Bearer ${authToken}` },
          });
          const usersData = await usersResponse.json();

          const managers =
            usersData.users?.filter(
              (u) => u.role?.toLowerCase() === "manager" // Only actual managers, not management/lead/super_admin
            ) || [];

          backendData = {
            clients: clientsData.data || [],
            managers: managers,
          };

          resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Backend APIs successful
                    </div>
                    <div class="data-display">
                        <h4>üìû Clients API (${
                          backendData.clients.length
                        } items):</h4>
                        ${backendData.clients
                          .map((c) => `‚Ä¢ ${c.name} (ID: ${c._id})`)
                          .join("<br>")}
                        
                        <h4 style="margin-top: 15px;">üë• Managers API (${
                          backendData.managers.length
                        } items):</h4>
                        ${backendData.managers
                          .map(
                            (m) => `‚Ä¢ ${m.full_name} (${m.role}) [ID: ${m.id}]`
                          )
                          .join("<br>")}
                    </div>
                `;
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå Backend API error: ${error.message}</div>`;
        }
      }

      async function testVoiceProcessing() {
        if (!authToken) {
          document.getElementById("voice-result").innerHTML =
            '<div class="warning">‚ö†Ô∏è Please authenticate first</div>';
          return;
        }

        const resultDiv = document.getElementById("voice-result");
        resultDiv.innerHTML =
          '<div class="info">Processing voice command...</div>';

        try {
          const response = await fetch(
            `${BACKEND_URL}/api/v1/voice/process-command`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${authToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                transcript: SAMPLE_COMMAND,
                context: {
                  user_id: "admin",
                  current_page: "projects",
                },
              }),
            }
          );

          const data = await response.json();
          voiceProcessingResult = data;

          if (data.actions && data.actions.length > 0) {
            const action = data.actions[0];
            const referenceFields =
              action.fields?.filter((f) => f.type === "reference") || [];
            const enumFields =
              action.fields?.filter((f) => f.type === "enum") || [];

            resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Voice processing successful
                        </div>
                        <div class="data-display">
                            <h4>üéØ Intent: ${action.intent}</h4>
                            <p><strong>Confidence:</strong> ${
                              action.confidence
                                ? Math.round(action.confidence * 100) + "%"
                                : "N/A"
                            }</p>
                            <p><strong>Fields detected:</strong> ${
                              action.fields?.length || 0
                            }</p>
                            
                            <h4>üîó Reference Fields (will use dropdowns):</h4>
                            ${referenceFields
                              .map(
                                (f) => `
                                <div class="dropdown-expected">
                                    <strong>${f.name}</strong> ‚Üí ${f.referenceType} dropdown (required: ${f.required})
                                </div>
                            `
                              )
                              .join("")}
                            
                            <h4>üìã Enum Fields (will use dropdowns):</h4>
                            ${enumFields
                              .map(
                                (f) => `
                                <div class="dropdown-expected">
                                    <strong>${f.name}</strong> ‚Üí [${
                                  f.enumValues?.join(", ") || "none"
                                }] dropdown
                                </div>
                            `
                              )
                              .join("")}
                            
                            <h4>üìù All Fields:</h4>
                            ${action.fields
                              ?.map(
                                (f) => `
                                <div style="margin: 5px 0; padding: 5px; background: ${
                                  f.type === "reference" || f.type === "enum"
                                    ? "#e3f2fd"
                                    : "#f5f5f5"
                                };">
                                    <strong>${f.name}</strong>: ${f.type} ${
                                  f.referenceType ? `(${f.referenceType})` : ""
                                } ${f.required ? "(required)" : ""}
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    `;
          } else {
            resultDiv.innerHTML = `<div class="error">‚ùå No actions detected in voice processing</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå Voice processing error: ${error.message}</div>`;
        }
      }

      async function analyzeModalRequirements() {
        if (!voiceProcessingResult || !backendData.clients) {
          document.getElementById("modal-analysis").innerHTML =
            '<div class="warning">‚ö†Ô∏è Please run previous tests first</div>';
          return;
        }

        const resultDiv = document.getElementById("modal-analysis");
        const action = voiceProcessingResult.actions[0];
        const fields = action.fields || [];

        const referenceFields = fields.filter((f) => f.type === "reference");
        const enumFields = fields.filter((f) => f.type === "enum");
        const otherFields = fields.filter(
          (f) => f.type !== "reference" && f.type !== "enum"
        );

        resultDiv.innerHTML = `
                <div class="success">
                    ‚úÖ Modal requirements analyzed
                </div>
                <div class="data-display">
                    <h4>üìä VoiceConfirmationModal Expected Behavior:</h4>
                    
                    <div class="field-analysis">
                        <h5>üîΩ DROPDOWN FIELDS (${
                          referenceFields.length + enumFields.length
                        } total):</h5>
                        
                        ${referenceFields
                          .map((f) => {
                            let dataStatus = "‚ö†Ô∏è Data source not verified";
                            let optionsCount = 0;

                            if (
                              f.referenceType === "client" &&
                              backendData.clients
                            ) {
                              dataStatus = `‚úÖ ${backendData.clients.length} options available`;
                              optionsCount = backendData.clients.length;
                            } else if (
                              f.referenceType === "manager" &&
                              backendData.managers
                            ) {
                              dataStatus = `‚úÖ ${backendData.managers.length} options available`;
                              optionsCount = backendData.managers.length;
                            }

                            return `
                                <div class="dropdown-expected">
                                    <strong>${f.name}</strong> (${f.referenceType})<br>
                                    Expected behavior: Dropdown populated from ${f.referenceType} API<br>
                                    ${dataStatus}
                                </div>
                            `;
                          })
                          .join("")}
                        
                        ${enumFields
                          .map(
                            (f) => `
                            <div class="dropdown-expected">
                                <strong>${f.name}</strong> (enum)<br>
                                Expected behavior: Dropdown with options [${
                                  f.enumValues?.join(", ") || "none"
                                }]<br>
                                ‚úÖ Static enum values defined
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                    
                    <div class="field-analysis">
                        <h5>üìù INPUT FIELDS (${otherFields.length} total):</h5>
                        ${otherFields
                          .map(
                            (f) => `
                            <div style="margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                                <strong>${f.name}</strong> (${f.type}): Regular ${f.type} input field
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background-color: #e8f5e8; border-radius: 8px;">
                        <h5>üéØ VERIFICATION CHECKLIST:</h5>
                        <div>‚úÖ ${
                          referenceFields.length
                        } reference dropdowns should be populated from backend APIs</div>
                        <div>‚úÖ ${
                          enumFields.length
                        } enum dropdowns should show predefined options</div>
                        <div>‚úÖ ${
                          otherFields.length
                        } regular input fields for data entry</div>
                        <div>‚úÖ All ${
                          fields.length
                        } fields should be properly mapped and editable in modal</div>
                    </div>
                </div>
            `;
      }

      async function simulateModalTrigger() {
        if (!voiceProcessingResult) {
          document.getElementById("frontend-result").innerHTML =
            '<div class="warning">‚ö†Ô∏è Please run voice processing test first</div>';
          return;
        }

        const resultDiv = document.getElementById("frontend-result");

        resultDiv.innerHTML = `
                <div class="info">
                    üîó Frontend Integration Instructions
                </div>
                <div class="data-display">
                    <h4>To verify VoiceConfirmationModal dropdown population:</h4>
                    
                    <ol>
                        <li><strong>Open the main application:</strong> <a href="http://localhost:5173" target="_blank">http://localhost:5173</a></li>
                        <li><strong>Navigate to Projects section</strong></li>
                        <li><strong>Use voice command or test interface</strong> to trigger: <br>
                            <code>"${SAMPLE_COMMAND}"</code></li>
                        <li><strong>Verify the VoiceConfirmationModal opens</strong></li>
                        <li><strong>Check these specific elements:</strong>
                            <ul>
                                <li>clientName field: Should show dropdown with ${
                                  backendData.clients?.length || "N/A"
                                } client options</li>
                                <li>managerName field: Should show dropdown with ${
                                  backendData.managers?.length || "N/A"
                                } manager options</li>
                                <li>status field: Should show dropdown with [Active, Completed, Archived] options</li>
                                <li>Other fields: Should show appropriate input types (text, date, number)</li>
                            </ul>
                        </li>
                        <li><strong>Test dropdown functionality:</strong>
                            <ul>
                                <li>Click Edit button in modal</li>
                                <li>Verify dropdowns are populated and selectable</li>
                                <li>Verify dropdown options match backend data exactly</li>
                                <li>Verify non-dropdown fields show as text inputs</li>
                            </ul>
                        </li>
                    </ol>
                    
                    <div style="margin-top: 20px; padding: 15px; background-color: #fff3cd; border-radius: 8px;">
                        <h5>‚ö†Ô∏è What to verify:</h5>
                        <div>‚Ä¢ Dropdown options should ONLY contain backend data (not hardcoded values)</div>
                        <div>‚Ä¢ Client dropdown should show: ${
                          backendData.clients?.map((c) => c.name).join(", ") ||
                          "N/A"
                        }</div>
                        <div>‚Ä¢ Manager dropdown should show: ${
                          backendData.managers
                            ?.map((m) => m.full_name)
                            .join(", ") || "N/A"
                        }</div>
                        <div>‚Ä¢ Status dropdown should show: Active, Completed, Archived</div>
                        <div>‚Ä¢ No other dropdowns should appear</div>
                    </div>
                </div>
            `;
      }

      // Auto-run authentication on page load
      window.addEventListener("load", () => {
        console.log("VoiceConfirmationModal Dropdown Test page loaded");
        console.log("Use the buttons above to run tests in sequence");
      });
    </script>
  </body>
</html>
